$(window).load(init);

function init() {
    switch (sv.pageID) {
        case "admin.signin":
            login.initialize("su");
            break;

        case "admin.dashboard":
            dashboard.initialize();
            break;

        case "category.add":
            category_add.initialize();
            break;

        case "packaging.add":
            packaging_add.initialize();
            break;

        case "item.home":
            item_home.initialize();
            break;

        case "item.edit":
            item_edit.initialize();
            break;
    }

    logout.set();
}

var utils = {
    //requires sha256.min.js
    sha256: function (value) {
        return CryptoJS.SHA256(value).toString(CryptoJS.enc.Hex);
    },

    //Fill a HTML <select></select> with list of values in JavaScript array
    fillDropDown: function ($el, data, name, value) {
        for (var i = 0; i < data.length; i++) {
            $('<option/>').text(data[i][name]).attr('value', data[i][value]).appendTo($($el));
        }
    },

    //Fill a HTML <select></select> with list of values in JavaScript data object
    fillDropDown2: function ($el, data, nameKey, valueKey) {
        $.each(data, function (key, value) {
            if (valueKey) key = value[valueKey];
            $('<option/>').text(value[nameKey]).attr('value', key).appendTo($($el));
        });
    },

    //Method to create a HTML DOM element
    createElement: function (element, parent, attributes) {
        /**
        * @params
        *
        * element
        * Type: Selector
        * e.g. "<div/>"
        * String name of element which is required to be created
        *
        * parent
        * Type: String | Element
        * e.g. "#foo", $("#foo"), document.getElementById('foo')
        * Parent element of the newly created element
        *
        * attributes
        * Type: Object
        * e.g. {'className': 'bar', html: "Lorem Ipsum", id: "foo"}
        * Object of attributes to be applied to this element
        */

        if (!attributes) attributes = {};

        //create specified element
        var $el = $(element, attributes);

        //append this element to parent, if available
        if (parent) $el.appendTo($(parent));

        //return the newly created element
        return $el;
    },

    //Method to create JavaScript object of all fields in a <form></form>
    formToObject: function (form) {
        /*
        * Fix #3: Updated method to use jQuery rather that raw HTML
        */
        var $form = $(form),
            json = {};

        //Get Inputs
        $('input', $form).each(function (index, el) {
            var $el = $(el);

            //stay away, if element is disabled
            if ($el.is(":disabled")) return;

            name = $el.attr("name");
            switch ($el.attr("type")) {
                case 'checkbox':
                    //For checkboxes, we need to send values 0/1 rather than 'on', which is natively provided by HTML
                    $el.prop("checked") ? json[name] = "1" : json[name] = "0";
                    break;

                case 'radio':
                    if ($el.prop("checked")) json[name] = $el.val();
                    break;

                default:
                    json[name] = $el.val();
                    break;
            }
        });

        //Get Selects and textareas
        $('select,textarea', $form).each(function (index, el) {
            var $el = $(el);

            //stay away, if element is disabled
            if ($el.is(":disabled")) return;

            json[$el.attr("name")] = $el.val();
        });

        return json;
    },

    //Method for removal for multiple keys(in array) from a JavaScript Object
    dropKeysFromObject: function (obj, dropFields) {
        for (var i = 0; i < dropFields.length; i++) {
            if (obj[dropFields[i]]) delete obj[dropFields[i]];
        }

        return obj;
    },

    //convert JSON string to JavaScript object
    JSONtoObject: function (json) {
        if (JSON) return JSON.parse(json);
        else return eval('(' + json + ')');
    },

    //get cookie from browser, for key provided
    getCookieValue: function (key) {
        return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(key).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
    },

    //convert a data array to object mapper
    createMapFromArray: function (dataArray, key) {
        var mapper = {};
        for (var i = 0, l = dataArray.length; i < l; i++) {
            mapper[dataArray[i][key]] = dataArray[i];
        }

        return mapper;
    },

    //get number of keys in object
    getObjectLength: function (a) {
        return $.map(a, function (n, i) { return i; }).length;
    },

    //compare first string with second, upto n number of characters
    strncmp: function (a, b, n) {
        return a.substring(0, n) == b.substring(0, n);
    },

    getURLVar: function (name) {
        return (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search) || [, null])[1];
    }
};

var login = {
    initialize: function (type) {
        var self = this;

        if (type == "su") {
            this.REDIRECT_URL = "/sugandh-vatika/admin/dashboard.php";
        }

        //check if something is found in cookies
        this.checkForCookies();

        //focus username/password at start
        if ($("#username").val() == "") $("#username").focus();
        else $("#password").focus();

        $("#signInForm").validate({
            highlight: function (element, errorClass, validClass) {
                $(element).parent().addClass("has-error");
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).parent().removeClass("has-error");
            },
            submitHandler: function (form) {
                //call method to submit this form
                self.signIn(self.REDIRECT_URL);

                return false;
            }
        });
    },

    signIn: function (REDIRECT_URL) {
        var jsdata = utils.formToObject("#signInForm");

        //convert actual password to hash
        jsdata.password = utils.sha256(jsdata.password);

        $.ajax({
            type: "POST",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=sign&op=in",
            data: jsdata,
            success: function (result) {
                if (utils.strncmp(result, "SUCCESS", 7)) {
                    window.location = REDIRECT_URL;
                } else {
                    alert("Error " + result);
                }
            }
        });
    },

    REDIRECT_URL: "/sugandh-vatika/admin/dashboard.php",

    checkForCookies: function () {
        var cookies = {
            "username": utils.getCookieValue("username"),
            "remember": utils.getCookieValue("remember")
        }

        $.each(cookies, function (key, value) {
            if (key === "remember" && value == 1) {
                $("#" + key).prop("checked", true);
            } else {
                $("#" + key).val(value);
            }
        });
    },
};

var dashboard = {
    initialize: function () {
        this.getModules(this.displayModules);
    },

    displayModules: function () {
        var modulesContainer = document.getElementById("modulesContainer");
        $.each(this.modules, function (key, value) {
            modulesContainer.innerHTML += '<div id="job-thumb" style="opacity: 1">\
             <div id="job-image">\
             <a href="' + value.href + '" class="">\
             <img width="600" height="600" src="' + value.image + '" class="lazy" style="visibility: visible; opacity: 1;">\
             <noscript><img src="' + value.image + '" width="600" height="600"></noscript></a></div>\
             <div id="job-heading"><h2 class="thumb-heading"><a href="' + value.href + '">' + value.name + '<br />\
             <p class="f12" style="margin-top: 8px;">' + value.description + '</p>\
             </a></h2></div></div>';
        });
    },

    getModules: function (callback) {
        var self = this;

        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=misc&op=getModules",
            success: function (data) {
                if (utils.strncmp(data, "ERROR", 5)) {
                    alert("No modules allowed");
                } else {
                    self.modules = utils.JSONtoObject(data);
                    callback.apply(self);
                }
            }
        });
    },

    modules: {}
};

var category_add = {
    initialize: function () {
        var self = this;

        //focus category name field at start
        $("#name").focus();

        //initialize cute crumbs for list of categories
        this.cuteCrumbs = new Cute_Crumbs({
            defaultText: "#categoryDefaultText",
            crumbsContainer: "#categoryCrumbsContainer",
            removeCallback: this.removeCategory,
            removeConfirmation: function () {
                if (confirm("Removing this category will remove all items associated with this category. Are you sure you want to proceed?"))
                    return true;

                return false;
            }
        });

        //add form submit listener with validation
        $("#addCategoryForm").validate({
            highlight: function (element, errorClass, validClass) {
                $(element).parent().addClass("has-error");
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).parent().removeClass("has-error");
            },
            submitHandler: function (form) {
                //call method to submit this form
                self.formSubmitCallback();

                return false;
            }
        });

        //get list of categories
        this.fetchCategories(this.listCategories);
    },

    //fetch list of categories
    fetchCategories: function (callback) {
        var self = this;

        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=category&op=list",
            success: function (data) {
                try {
                    data = utils.JSONtoObject(data);
                } catch (ex) {
                    console.log("list of categories not found");
                    return;
                }

                if (callback) callback.apply(self, [data]);
            }
        });
    },

    listCategories: function (categoriesArray) {
        this.cuteCrumbs.add(categoriesArray);
    },

    removeCategory: function (info) {
        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=category&op=remove&cid=" + info.id,
            success: function (result) {
                //removed
            }
        });
    },

    successMessageTimeout: null,

    categoryAdded: function () {
        //show category added, success message
        $("#successMessage-1").show();

        //hide message after 8 secs
        if (this.successMessageTimeout) window.clearTimeout(this.successMessageTimeout);
        this.successMessageTimeout = window.setTimeout(function () {
            $("#successMessage-1").hide();
        }, 8000);

        //clear form and focus category name
        $("#addCategoryForm").find("input[type=text], textarea").val("");
        $("#name").focus();
    },

    formSubmitCallback: function () {
        var self = this,
            jsdata = utils.formToObject("#addCategoryForm");

        $.ajax({
            type: "POST",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=category&op=add",
            data: jsdata,
            success: function (result) {
                if (+result) {
                    jsdata["id"] = result;

                    self.categoryAdded();
                    self.listCategories([jsdata]);
                } else {
                    alert("Unable to add category");
                }
            }
        });
    }
};

var packaging_add = {
    initialize: function () {
        var self = this;

        //fill in list of categories
        category_add.fetchCategories(function (categoriesList) {
            utils.fillDropDown("#category", categoriesList, "name", "id");
        });

        //initialize cute crumbs for list of packagings
        this.cuteCrumbs = new Cute_Crumbs({
            defaultText: "#defaultText",
            crumbsContainer: "#crumbsContainer",
            removeCallback: null,
            removeConfirmation: null,
            noRemove: true
        });

        //add form submit listener with validation
        $("#addPackagingForm").validate({
            highlight: function (element, errorClass, validClass) {
                $(element).parent().addClass("has-error");
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).parent().removeClass("has-error");
            },
            submitHandler: function (form) {
                //call method to submit this form
                self.add();

                return false;
            }
        });

        //get list of packagings
        this.getList(this.listPackagings);
    },

    //add a new packaging - request
    add: function () {
        var self = this,
            jsdata = utils.formToObject("#addPackagingForm");

        $.ajax({
            type: "POST",
            async: true,
            data: jsdata,
            url: "/sugandh-vatika/php/iface.php?fx=packaging&op=add",
            success: function (result) {
                if (+result) {
                    jsdata["id"] = result;

                    self.packagingAdded();
                    self.listPackagings([jsdata]);
                } else {
                    alert("Unable to add category");
                }
            }
        });
    },

    //called when a packaging is added successfully
    packagingAdded: function () {
        //show category added, success message
        $("#successMessage-1").show();

        //hide message after 8 secs
        if (this.successMessageTimeout) window.clearTimeout(this.successMessageTimeout);
        this.successMessageTimeout = window.setTimeout(function () {
            $("#successMessage-1").hide();
        }, 8000);

        //clear form and focus value
        $("#addPackagingForm").find("input[type=text], textarea").val("");
        $("#name").focus();
    },

    //get list of packagings
    getList: function (callback) {
        var self = this;

        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=packaging&op=list",
            success: function (data) {
                try {
                    data = utils.JSONtoObject(data);
                } catch (ex) {
                    console.log("list of packagings not found");
                    return;
                }

                if (callback) callback.apply(self, [data]);
            }
        });
    },

    //create list of packagings
    listPackagings: function (datarray) {
        for (var i = 0, l = datarray.length; i < l; i++) {
            datarray[i]["name"] = datarray[i]["value"] + " " + datarray[i]["metric"];
        }

        this.cuteCrumbs.add(datarray);
    }
};

var item_home = {
    initialize: function () {
        var self = this;

        //fill in list of categories
        category_add.fetchCategories(function (categoriesList) {
            utils.fillDropDown("#catid", categoriesList, "name", "id");
        });

        //remove independent 'required' messages
        jQuery.validator.messages.required = "";

        //add form submit listener with validation
        $("#addItemForm").validate({
            highlight: function (element, errorClass, validClass) {
                $(element).parent().addClass("has-error");
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).parent().removeClass("has-error");
            },
            submitHandler: function (form) {
                //call method to submit this form
                self.addItemHandler();

                return false;
            },
            invalidHandler: function (ev, validator) {
                if (validator.numberOfInvalids()) {
                    $("#errorMessage-1").show();
                } else {
                    $("#errorMessage-1").hide();
                }
            }
        });

        // get list of items and print it
        this.fetchAllItems(this.printList);
    },

    addItemHandler: function () {
        var jsdata = utils.formToObject("#addItemForm");

        $.ajax({
            type: "POST",
            async: true,
            data: jsdata,
            url: "/sugandh-vatika/php/iface.php?fx=item&op=add",
            success: function (result) {
                if (+result) {
                    window.location = "/sugandh-vatika/admin/item_edit.php?id=" + result;
                } else {
                    console.log("item not added to database " + result);
                    return;
                }
            }
        });
    },

    // fetch list of all items
    fetchAllItems: function (callback) {
        var self = this;

        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=item&op=list",
            success: function (data) {
                try {
                    data = utils.JSONtoObject(data);
                } catch (ex) {
                    console.log("unable to fetch list of items");
                    return;
                }

                if (callback) callback.apply(self, [data]);
            }
        });
    },

    // print list of items
    printList: function (itemsArray) {
        for (var i = 0, l = itemsArray.length; i < l; i++) {
            this.addItemRow(itemsArray[i]);
        }
    },

    // add an item to list of items
    addItemRow: function (item) {
        /***
        * TODO
        * apply event listeners for remove or anything else
        ***/

        var item = this.createItemRow(item);
        $("#itemsList").append(item);
    },

    // create a new item row
    createItemRow: function (details) {
        return  '<li class="list_view">\
                    <div class="col-1">' + details.name + '</div>\
                    <div class="col-2">' + details.price + '</div>\
                    <div class="col-3">' + details.discountid + '</div>\
                    <div class="clearfix"></div>\
                </li>';
    }
};

var item_edit = {
    initialize: function () {
        var self = this;

        //get item id from URL
        this.itemID = utils.getURLVar("id");

        //configure dropzone
        this.dzn = new Dropzone("div#img_upload", {
            url: "/sugandh-vatika/php/iface.php?fx=item&op=image.add&itemid=" + self.itemID,
            previewsContainer: "#img_upload",
            acceptedFiles: "image/*",
            addRemoveLinks: true,
            clickable: ".dropzoneContainer",
            accept: function (imageObj, done) {
                if (self.isDuplicateImageName(imageObj)) {
                    done("This file has already been uploaded.");
                } else {
                    done();
                }
            },
            init: function () {
                //file added
                this.on("addedfile", function (file) { $(".dd-default").css("opacity", 0); });

                //all files removed
                this.on("reset", function () { $(".dd-default").css("opacity", 1); });

                //adding image
                this.on("success", function (imageObj, serverResponse) {
                    self.imageMap[+serverResponse] = imageObj;
                    imageObj.previewTemplate["id"] = +serverResponse;
                });

                //removing image
                this.on("removedfile", function (imageObj) {
                    var id = imageObj.previewTemplate["id"];
                    
                    $.ajax({
                        type: "DELETE",
                        async: true,
                        url: "/sugandh-vatika/php/iface.php?fx=item&op=image.remove&id=" + id,
                        success: function (result) {
                            delete self.imageMap[id];
                        }
                    });
                });
            }
        });
        
        //get images
        this.getImages(this.showPreviousImages);

        //fill in list of categories
        category_add.fetchCategories(function (categoriesList) {
            utils.fillDropDown("#catid", categoriesList, "name", "id");

            //get list of packagings
            packaging_add.getList(function (packagingsList) {
                utils.fillDropDown("#packagings", packagingsList, "name", "id");
            });

            //get item details after categories are fetched
            self.getItem(self.fillForm);
        });
    },

    getItem: function (callback) {
        var self = this;

        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=item&op=get.id&id=" + this.itemID,
            success: function (data) {
                data = utils.JSONtoObject(data)[0];

                if (callback) callback(data);
            }
        });
    },

    fillForm: function (dataObject) {
        $.each(dataObject, function (key, value) {
            $("#" + key).val(value);
        });
    },

    imageMap: {},

    isDuplicateImageName: function (image) {
        var result = false;
        $.each(this.imageMap, function (key, value) {
            if (value.name == image.name) result = true;
        });

        return result;
    },

    getImages: function (callback) {
        var self = this;

        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=item&op=image.get&itemid=" + this.itemID,
            success: function (data) {
                data = utils.JSONtoObject(data);

                if(callback) callback.apply(self, [data]);
            }
        });
    },

    showPreviousImages: function (imagesArray) {
        for (var i = 0, l = imagesArray.length; i < l; i++) {
            this.makeMockImage(imagesArray[i]);
        }
    },

    makeMockImage: function (details) {
        var mockFile = { name: details.name, size: details.size };

        //add file
        this.dzn.emit("addedfile", mockFile);

        //associate with id
        this.dzn.emit("success", mockFile, details.id);

        //show a thumbnail
        this.dzn.emit("thumbnail", mockFile, details.path);

        this.dzn.files.push(mockFile);
    }
};

var logout = {
    set: function () {
        $(".logout").on('click', this._do);
    },

    _do: function () {
        $.ajax({
            type: "GET",
            async: true,
            url: "/sugandh-vatika/php/iface.php?fx=sign&op=out",
            success: function (result) {
                if (result == "SUCCESS") {
                    window.location = "/sugandh-vatika/admin/login.html";
                }
            }
        });
    }
};